<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPWA Live Monitor - Gem Master Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        .mono { font-family: 'JetBrains+Mono', monospace; }
        .data-card { transition: all 0.3s ease; height: 100%; }
        
        @keyframes alarm-pulse {
            0% { background-color: rgba(30, 41, 59, 0.4); }
            50% { background-color: rgba(220, 38, 38, 0.6); box-shadow: 0 0 25px rgba(220, 38, 38, 0.5); }
            100% { background-color: rgba(30, 41, 59, 0.4); }
        }
        .wind-alarm-active { animation: alarm-pulse 1.2s infinite; border-color: #ef4444 !important; }

        .live-dot.active { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); animation: pulse-green 2s infinite; background-color: #22c55e; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .spin-anim { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #wind-arrow { display: inline-block; transition: transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .legend-tooltip {
            visibility: hidden; opacity: 0; position: absolute; top: 40px; right: 0;
            background: rgba(15, 23, 42, 0.99); border: 2px solid #3b82f6;
            padding: 24px; border-radius: 1.5rem; color: white; z-index: 50; 
            width: 320px; transition: all 0.2s ease; box-shadow: 0 20px 40px rgba(0,0,0,0.7);
            backdrop-filter: blur(12px); text-align: left;
        }
        .legend-trigger:hover .legend-tooltip { visibility: visible; opacity: 1; top: 50px; }

        .tooltip-box {
            visibility: hidden; opacity: 0; position: fixed; bottom: 120px; left: 50%;
            transform: translateX(-50%); background: rgba(15, 23, 42, 0.98); border: 2px solid #3b82f6;
            padding: 30px; border-radius: 2rem; color: white; z-index: 100; width: 90%;
            max-width: 800px; transition: all 0.2s ease-out; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            pointer-events: none; backdrop-filter: blur(12px);
        }
        .has-tooltip:hover .tooltip-box { visibility: visible; opacity: 1; bottom: 140px; }
    </style>
</head>
<body class="bg-black text-slate-100 min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="max-w-6xl w-full bg-slate-900 rounded-[3rem] shadow-2xl overflow-hidden border border-slate-800 relative">
        <div id="freshness-bar" class="w-full h-2 bg-slate-700 absolute top-0 left-0 transition-all duration-1000"></div>

        <div class="p-8 pb-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-8 px-6 text-center">
                <div class="flex-1 flex flex-col items-center">
                    <div id="clock-local" class="text-[4.5rem] font-black text-white tracking-tighter mono leading-none">00:00:00</div>
                    <div id="clock-zulu" class="text-blue-400 text-lg font-bold tracking-[0.2em] mono mt-3 w-full text-center">ZULU: 00:00Z</div>
                </div>
                <div class="flex-1">
                    <h1 class="text-8xl font-black tracking-tighter text-white leading-none">EPWA</h1>
                    <p class="text-blue-400 text-sm font-bold tracking-[0.4em] uppercase mt-2">Warszawa Chopin</p>
                </div>
                <div class="flex-1 flex justify-center md:justify-end">
                    <div class="flex items-center space-x-3 bg-slate-800 px-6 py-3 rounded-full border border-slate-700">
                        <span id="status-dot" class="w-3 h-3 rounded-full bg-gray-500 live-dot"></span>
                        <p id="status-text" class="text-xs font-bold text-slate-400 tracking-widest uppercase">≈ÅƒÖczenie...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="px-8 grid grid-cols-1 md:grid-cols-3 gap-6 items-stretch mb-8">
            <div class="flex flex-col items-center justify-center p-6 bg-slate-800/20 rounded-[2.5rem] border border-slate-800/50">
                <div class="bg-slate-800/50 p-8 rounded-full border border-slate-700/30 shadow-inner mb-6">
                    <i id="weather-icon" class="bi bi-cloud-fill text-8xl text-slate-600"></i>
                </div>
                <p id="weather-desc" class="text-3xl font-bold text-white capitalize mb-2 text-center">Czekam...</p>
                <p id="time-ago" class="text-xs font-mono text-slate-500 bg-black/40 px-4 py-2 rounded-full border border-slate-800 uppercase tracking-tighter">---</p>
            </div>

            <div class="flex flex-col gap-4">
                <div id="wind-card" class="data-card bg-slate-800/40 p-6 rounded-[2rem] border border-slate-700/50 flex flex-col items-center justify-center text-center">
                    <p class="text-xs uppercase text-slate-500 font-bold mb-2">Wiatr</p>
                    <div class="flex items-center gap-4">
                        <p id="wind" class="font-bold text-xl text-white">-</p>
                        <i id="wind-arrow" class="bi bi-arrow-up text-blue-400 text-4xl"></i>
                    </div>
                </div>
                <div class="data-card bg-slate-800/40 p-6 rounded-[2rem] border border-slate-700/50 flex flex-col items-center justify-center text-center">
                    <p class="text-xs uppercase text-slate-500 font-bold mb-2">Widzialno≈õƒá</p>
                    <p id="vis" class="font-bold text-2xl text-white">-</p>
                </div>
                <div class="data-card bg-slate-800/40 p-6 rounded-[2rem] border border-slate-700/50 flex flex-col items-center justify-center text-center">
                    <p class="text-xs uppercase text-slate-500 font-bold mb-2">Temp / Ci≈õnienie</p>
                    <p class="font-bold text-2xl text-white"><span id="temp">-</span> / <span id="qnh">-</span></p>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <div id="flight-category-card" class="p-5 rounded-[2rem] border border-slate-800 bg-slate-800/20 flex flex-col justify-center text-center">
                    <p class="text-xs uppercase opacity-70 font-bold mb-1">Warunki Lotu</p>
                    <p id="flight-category-text" class="font-black text-2xl uppercase">---</p>
                </div>
                <div class="data-card bg-blue-900/10 p-6 rounded-[2rem] border border-blue-900/30 flex flex-col items-center relative">
                    <div class="flex items-center space-x-2 mb-4 legend-trigger cursor-help">
                        <p class="text-xs uppercase text-blue-400 font-bold tracking-widest text-center">Prognoza na dzi≈õ</p>
                        <i class="bi bi-info-circle text-blue-400 text-sm"></i>
                        <div class="legend-tooltip font-sans">
                            <p class="text-xs font-black text-blue-400 uppercase border-b border-blue-900/50 pb-3 mb-3 tracking-widest">Legenda GEMA</p>
                            <div class="space-y-3 mb-4 border-b border-blue-900/30 pb-3">
                                <div class="flex items-center gap-3 font-bold text-xs">
                                    <div class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]"></div> 
                                    <span class="text-slate-100">Prognoza sta≈Ça / pewna</span>
                                </div>
                                <div class="flex items-center gap-3 font-bold text-xs">
                                    <div class="w-3 h-3 rounded-full bg-blue-400 shadow-[0_0_8px_rgba(96,165,250,0.5)]"></div> 
                                    <span class="text-slate-100">Zmiana (TEMPO/BECMG)</span>
                                </div>
                                <div class="flex items-center gap-3 font-bold text-xs">
                                    <i class="bi bi-percent text-blue-300 text-lg"></i> 
                                    <span class="text-blue-200">Prawdopodobie≈Ñstwo (PROB)</span>
                                </div>
                            </div>
                            <p class="text-xs font-black text-red-400 uppercase mb-3 tracking-widest">Kategorie lotu:</p>
                            <div class="space-y-3">
                                <div class="text-xs font-bold leading-relaxed">
                                    <span class="text-red-400">IFR:</span> 
                                    <span class="text-slate-100 font-normal"> Widzialno≈õƒá &lt; 5km LUB chmury (BKN/OVC) poni≈ºej 1500ft.</span>
                                </div>
                                <div class="text-xs font-bold leading-relaxed">
                                    <span class="text-green-400">VFR:</span> 
                                    <span class="text-slate-100 font-normal"> Pogoda umo≈ºliwiajƒÖca lot z widoczno≈õciƒÖ ziemi.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="taf-visual" class="flex justify-center items-center flex-wrap gap-5 flex-grow py-3"></div>
                    <p id="taf-decoded" class="text-sm text-blue-100 font-medium leading-snug text-center mt-3 border-t border-blue-900/30 pt-4 pb-2 w-full">Analizowanie...</p>
                </div>
            </div>
        </div>

        <div class="px-8 pb-8 space-y-4">
            <div class="bg-black/40 p-6 rounded-[2rem] border border-slate-800 mono text-xs">
                <div class="has-tooltip cursor-help mb-3">
                    <p id="raw-metar" class="text-slate-400 italic text-sm">METAR: ...</p>
                    <div class="tooltip-box">
                        <p class="text-blue-400 text-xs font-bold uppercase mb-3">Pe≈Çna depesza METAR</p>
                        <p id="tooltip-metar" class="text-4xl font-bold mono tracking-tight text-white leading-relaxed">---</p>
                    </div>
                </div>
                <div class="has-tooltip cursor-help border-t border-slate-800/50 pt-3">
                    <p id="taf-text" class="text-slate-600 text-sm">TAF: ---</p>
                    <div class="tooltip-box">
                        <p class="text-blue-400 text-xs font-bold uppercase mb-3">Pe≈Çna depesza TAF</p>
                        <p id="tooltip-taf" class="text-4xl font-bold mono tracking-tight text-white leading-relaxed">---</p>
                    </div>
                </div>
            </div>
            <button onclick="fetchMetar()" class="w-full bg-blue-600 hover:bg-blue-500 py-6 rounded-[1.5rem] font-bold text-xl tracking-[0.2em] shadow-lg shadow-blue-900/20 flex items-center justify-center space-x-4 transition-all active:scale-95 group">
                <i class="bi bi-arrow-repeat text-2xl group-active:rotate-180 transition-transform"></i>
                <span>OD≈öWIE≈ª MONITOR</span>
            </button>
        </div>
    </div>

    <script>
        const API_KEY = "96d7df72f6c749e0b3e21c828f851c02";
        function updateClocks() {
            const now = new Date();
            document.getElementById('clock-local').innerText = now.toLocaleTimeString('pl-PL', { hour12: false });
            const zHours = String(now.getUTCHours()).padStart(2, '0');
            const zMinutes = String(now.getUTCMinutes()).padStart(2, '0');
            document.getElementById('clock-zulu').innerText = `ZULU: ${zHours}:${zMinutes}Z`;
        }
        setInterval(updateClocks, 1000);
        updateClocks();

        function getTafIcons(raw) {
            const container = document.getElementById('taf-visual');
            container.innerHTML = "";
            const probMatch = raw.match(/PROB(\d{2})/);
            const probVal = probMatch ? probMatch[1] + "%" : null;
            const sections = raw.split(/(TEMPO|BECMG|PROB\d{2})/);
            const mainSection = sections[0];
            const changeSections = raw.replace(mainSection, "");
            const conditions = [
                { key: "TS", icon: "bi-cloud-lightning-rain-fill", label: "Burze" },
                { key: "SN", icon: "bi-cloud-snow-fill", label: "≈önieg" },
                { key: "RA", icon: "bi-cloud-drizzle-fill", label: "Deszcz" },
                { key: "FG", icon: "bi-cloud-fog2-fill", label: "Mg≈Ça" },
                { key: "BKN", icon: "bi-clouds-fill", label: "Chmury" },
                { key: "OVC", icon: "bi-clouds-fill", label: "Pochmurno" }
            ];
            let anyFound = false;
            conditions.forEach(c => {
                let colorClass = "text-slate-600", isActive = false, showProb = false;
                if (mainSection.includes(c.key)) { colorClass = "text-green-500"; isActive = true; }
                else if (changeSections.includes(c.key)) {
                    colorClass = "text-blue-400"; isActive = true;
                    if (probVal && raw.split(/PROB\d{2}/)[1]?.includes(c.key)) showProb = true;
                }
                if (isActive) {
                    anyFound = true;
                    container.innerHTML += `<div class="flex flex-col items-center"><i class="bi ${c.icon} ${colorClass} text-4xl drop-shadow-md"></i><span class="text-[9px] uppercase mt-2 font-black ${colorClass}">${c.label}</span>${showProb ? `<span class="text-[10px] font-bold text-blue-300 mt-0.5">${probVal}</span>` : ''}</div>`;
                }
            });
            if (!anyFound) container.innerHTML = `<i class="bi bi-sun-fill text-green-500 text-5xl"></i>`;
        }

        function decodeAviationCode(raw) {
            if (!raw || raw === "Prognoza niedostƒôpna") return raw;
            const probMatch = raw.match(/PROB(\d{2})/);
            const probVal = probMatch ? ` (${probMatch[1]}%)` : "";
            if (raw.includes("TEMPO")) return `‚ö†Ô∏è <span class='text-blue-400 font-bold uppercase'>Mo≈ºliwe czasowo</span>${probVal}: kr√≥tkie pogorszenie.`;
            if (raw.includes("BECMG")) return `üîÑ <span class='text-blue-300 font-bold uppercase'>W zmianie</span>: pogoda ulegnie sta≈Çej zmianie.`;
            return "‚úÖ <span class='text-green-400 font-bold uppercase'>Prognoza sta≈Ça</span>: brak zmian w depeszy.";
        }

        async function fetchMetar() {
            setLoading(true);
            try {
                const [metarRes, tafRes] = await Promise.all([
                    fetch(`https://api.checkwx.com/metar/EPWA/decoded`, { headers: { 'X-API-Key': API_KEY } }),
                    fetch(`https://api.checkwx.com/taf/EPWA/decoded`, { headers: { 'X-API-Key': API_KEY } })
                ]);
                const mData = (await metarRes.json()).data[0];
                const tData = (await tafRes.json()).data?.[0];
                updateUI({
                    raw: mData?.raw_text || "Brak danych", wind_dir: mData?.wind?.degrees ?? 0, wind_spd: mData?.wind?.speed_kts ?? 0, wind_gust: mData?.wind?.gust_kts ?? 0,
                    visibility: mData?.visibility?.meters ?? 9999, temp: mData?.temperature?.celsius ?? "--", qnh: mData?.barometer?.hpa ?? "--",
                    taf: tData?.raw_text || "Prognoza niedostƒôpna"
                }, "LIVE");
            } catch (error) { updateUI(generateDemo(), "DEMO"); }
            finally { setLoading(false); }
        }

        function updateUI(data, mode) {
            const windCard = document.getElementById('wind-card'), windIcon = document.getElementById('wind-arrow');
            const isDanger = data.wind_spd >= 30 || data.wind_gust >= 30;
            if (isDanger) { windCard.classList.add('wind-alarm-active'); windIcon.className = "bi bi-exclamation-triangle-fill text-red-500 text-4xl animate-bounce"; }
            else { windCard.classList.remove('wind-alarm-active'); windIcon.className = "bi bi-arrow-up text-blue-400 text-4xl"; }
            let windDesc = `${data.wind_dir}¬∞ / ${data.wind_spd}`;
            if(data.wind_gust > 0) windDesc += `-${data.wind_gust}`;
            document.getElementById('wind').innerHTML = `${windDesc} KT <span class="text-blue-400 text-lg">(${Math.round(data.wind_spd*1.85)} km/h)</span>`;
            document.getElementById('raw-metar').innerText = "METAR: " + data.raw;
            document.getElementById('tooltip-metar').innerText = data.raw;
            document.getElementById('vis').innerText = data.visibility >= 9999 ? ">10 km" : `${data.visibility} m`;
            document.getElementById('temp').innerText = `${data.temp}¬∞C`;
            document.getElementById('qnh').innerText = `${data.qnh} hPa`;
            document.getElementById('taf-text').innerText = "TAF: " + data.taf;
            document.getElementById('tooltip-taf').innerText = data.taf;
            document.getElementById('taf-decoded').innerHTML = decodeAviationCode(data.taf);
            document.getElementById('wind-arrow').style.transform = isDanger ? "none" : `rotate(${data.wind_dir}deg)`;
            getTafIcons(data.taf);
            updateFlightCategory(data.visibility, data.raw);
            updateWeatherVisuals(data.raw);
            const age = calculateAge(data.raw);
            document.getElementById('time-ago').innerText = age.text;
            const bar = document.getElementById('freshness-bar');
            if (mode === "LIVE") {
                document.getElementById('status-dot').className = "w-3 h-3 rounded-full live-dot active";
                document.getElementById('status-text').innerText = "LIVE";
                bar.className = `w-full h-2 absolute top-0 left-0 transition-all duration-1000 ${age.min < 45 ? 'bg-green-500 shadow-[0_0_15px_#22c55e]' : 'bg-red-500'}`;
            } else { document.getElementById('status-text').innerText = "DEMO MODE"; bar.className = "w-full h-2 bg-orange-500 absolute top-0 left-0"; }
        }

        function updateFlightCategory(vis, raw) {
            const card = document.getElementById('flight-category-card');
            const isIFR = vis < 5000 || raw.match(/(BKN|OVC)0(0\d|1[0-5])/);
            document.getElementById('flight-category-text').innerText = isIFR ? "IFR (Instrumentalne)" : "VFR (Wizualne)";
            card.className = isIFR ? "p-5 rounded-[2rem] border border-red-500/30 bg-red-500/10 text-red-400 text-center" : "p-5 rounded-[2rem] border border-green-500/30 bg-green-500/10 text-green-400 text-center";
        }

        function updateWeatherVisuals(raw) {
            const iconEl = document.getElementById('weather-icon'), descEl = document.getElementById('weather-desc');
            let icon = "bi-cloud-fill", color = "text-slate-400", text = "Zachmurzenie";
            if (raw.includes("TS")) { icon="bi-cloud-lightning-rain-fill"; color="text-yellow-400"; text="Burza"; }
            else if (raw.includes("RA")) { icon="bi-cloud-drizzle-fill"; color="text-blue-400"; text="Deszcz"; }
            else if (raw.includes("CAVOK") || raw.includes("SKC")) { icon="bi-sun-fill"; color="text-yellow-500"; text="Czyste niebo"; }
            iconEl.className = `bi ${icon} text-8xl ${color}`;
            descEl.innerText = text;
        }

        function calculateAge(raw) {
            const match = raw.match(/\b(\d{2})(\d{2})(\d{2})Z\b/);
            if (!match) return { text: "---", min: 0 };
            const now = new Date();
            const report = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), parseInt(match[1]), parseInt(match[2]), parseInt(match[3])));
            const diff = Math.floor((now - report) / 60000);
            return { text: `RAPORT SPRZED ${diff} MIN`, min: diff };
        }

        function generateDemo() { return { raw: "EPWA 141630Z 24035G45KT 9999 BKN020 05/M01 Q1012", wind_dir: 240, wind_spd: 35, wind_gust: 45, visibility: 9999, temp: 5, qnh: 1012, taf: "TAF EPWA 141130Z 1412/1512 24015KT 9999 BKN020 PROB40 TEMPO 1414/1418 3000 RA BR" }; }
        function setLoading(s) { const btn = document.querySelector('.bi-arrow-repeat'); if(btn) s ? btn.classList.add('spin-anim') : setTimeout(()=>btn.classList.remove('spin-anim'), 600); }

        setInterval(fetchMetar, 600000);
        window.onload = fetchMetar;
    </script>
</body>
</html>